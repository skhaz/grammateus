<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title></title>
    <style type="text/css">
      html {
        overflow-x: hidden;
        height: 100%;
      }

      body {
        margin: 0px;
        padding: 0px;
        font-family: sans-serif;
        font-display: swap;
      }

      #input {
        appearance: none;
        font-size: 16px;
        color: #333;
        width: 100%;
        background-color: #eee;
        border: none;
        padding: 10px 16px 11px 16px;
        border-radius: 100px;
        box-shadow: none;
        outline: none;
        margin: 0;
        box-sizing: border-box;
      }

      .outer {
        margin: 0 auto;
        max-width: 600px;
        padding: 80px 20px;
      }
    </style>
  </head>

  <body>
    <main id="container"></main>

    <script type="text/javascript">
      const element = document.getElementById("container");

      const onSubmit = (event) => {
        event.preventDefault();

        const input = document.getElementById("input");
        var el = document.createElement("a");
        el.href = input.value;

        const user = el.pathname.replace(/\/$/, "").split("/").slice(-1).pop().trim().toLowerCase();

        if (user) {
          window.location.hash = new URLSearchParams({
            room: user,
            batch: 10,
          }).toString();
        }
      };

      const renderInput = () => {
        element.innerHTML = `
        <form class="outer" action="#" onsubmit="onSubmit(event); return false;" >
          <label for="input">
            <p>enter your <b>twitch</b> profile (make sure you're in live.)</p>
          </label>
          <input id="input" type="text" placeholder="rodrigodelduca or https://www.twitch.tv/rodrigodelduca"></input>
        </form>      
      `;
      };

      const renderSummary = () => {
        const { room, batch } = Object.fromEntries(new URLSearchParams(window.location.hash.substr(1)).entries());
        element.innerHTML = "";

        const params = new URLSearchParams();
        params.set("room", room);
        params.set("batch", batch);

        const url = new URL("/summary?" + params.toString(), window.location.href);

        function fetchData() {
          const controller = new AbortController();
          const signal = controller.signal;

          const id = setTimeout(() => {
            controller.abort();
          }, 60 * 1000);

          fetch(url.toString(), { signal })
            .then((response) => {
              clearTimeout(id);

              if (!response.ok) {
                throw new Error("Erro na resposta da requisição");
              }
              return response.json();
            })
            .then((data) => {
              console.log(data);
              fetchData();
            })
            .catch((error) => {
              console.error(error);
              setTimeout(fetchData, 10 * 1000);
            });
        }

        fetchData();
      };

      const render = () => {
        window.location.href.includes("#") ? renderSummary() : renderInput();
      };

      document.addEventListener("DOMContentLoaded", render);
      window.addEventListener("hashchange", render);
    </script>
  </body>
</html>
